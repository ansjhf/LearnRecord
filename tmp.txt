import com.alibaba.excel.EasyExcel;
import com.alibaba.excel.context.AnalysisContext;
import com.alibaba.excel.event.AnalysisEventListener;

import java.util.*;

public class ExcelDbImport {

    public static void readAndInsert(String filePath) {
        EasyExcel.read(filePath, new AnalysisEventListener<Map<Integer, String>>() {

            private List<String> headers = new ArrayList<>();
            private List<Map<String, String>> buffer = new ArrayList<>();
            private final int BATCH_SIZE = 1000;

            private boolean isHeaderParsed = false;

            @Override
            public void invoke(Map<Integer, String> rowData, AnalysisContext context) {
                if (!isHeaderParsed) {
                    // 解析表头
                    for (int i = 0; i < rowData.size(); i++) {
                        headers.add(rowData.getOrDefault(i, ""));
                    }
                    isHeaderParsed = true;
                    return;
                }

                // 解析数据行
                Map<String, String> record = new LinkedHashMap<>();
                for (int i = 0; i < headers.size(); i++) {
                    String key = headers.get(i);
                    String value = rowData.getOrDefault(i, "");
                    record.put(key, value);
                }
                buffer.add(record);

                // 分批插入数据库
                if (buffer.size() >= BATCH_SIZE) {
                    insertToDatabase(buffer);
                    buffer.clear();
                }
            }

            @Override
            public void doAfterAllAnalysed(AnalysisContext context) {
                if (!buffer.isEmpty()) {
                    insertToDatabase(buffer);
                }
                System.out.println("数据全部处理完成");
            }

        }).headRowNumber(0).sheet(0).doRead();
    }

    private static void insertToDatabase(List<Map<String, String>> rows) {
        // 这里你可以执行批量插入数据库操作
        // 例如使用 MyBatis、JDBC、JPA 等
        System.out.println("插入数据条数：" + rows.size());
        // 示例：打印第一条数据字段
        if (!rows.isEmpty()) {
            System.out.println("字段：" + rows.get(0).keySet());
        }
    }

    public static void main(String[] args) {
        String filePath = "large.xlsx";
        readAndInsert(filePath);
    }
}